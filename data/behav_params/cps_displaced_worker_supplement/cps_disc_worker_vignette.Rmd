---
# title: "CPS Displaced Worker Supplement"
# author: "Ebba Mark"
# date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: xelatex
header-includes:
  - \usepackage[table]{xcolor}
  - \usepackage{tabularray}
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{codehigh}
  - \usepackage[normalem]{ulem}
  - \UseTblrLibrary{booktabs}
  - \UseTblrLibrary{siunitx}
  - \newcommand{\tinytableTabularrayUnderline}[1]{\underline{#1}}
  - \newcommand{\tinytableTabularrayStrikeout}[1]{\sout{#1}}
  - \NewTableCommand{\tinytableDefineColor}[3]{\definecolor{#1}{#2}{#3}}
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

As part of the Current Population Survey, the US Census Bureau conducts an annual [Displaced Worker Supplement](https://cps.ipums.org/cps/dw_sample_notes.shtml) in which workers who have lost their job in the last three years are asked additional questions about their unemployment experiences and (if re-employed) their re-employment conditions. 

As reported in the survey documentation linked above, "the universe for the Displaced Workers Supplement is civilians 20 or older. Respondents are further categorized as a `displaced worker' if they meet additional characteristics (see DWSTAT). Users should note that there is an important difference in definition of displaced worker across samples. Before 1994, displaced workers are those who lost or left a job during the past 5 years. After 1994, displaced workers are those who lost or left a job due to layoffs or shutdowns within the past 3 years. **For 1998 on, respondents are only considered displaced workers if they had lost or left a job due to layoffs or shutdowns within the past 3 years, were not self-employed, and did not expect to be recalled to work within the next six months. Self-response was not required for this supplement after 1994, so often one individual answered for all household members.**"

We utilize the information reported on an individual's weekly wage at their lost job, wage at their new job, and the time spent unemployed to derive a measure of duration-dependent reservation wage adjustment. More precisely, we regress the ratio of the new wage to the wage at the lost job on unemployment duration and various control variables in a cross-sectional setting. We compare the model fit across linear, quadratic, and cubic specificaitions, with and without various combinations of control variables (whether or not an individual received unemployment compensation, age, race, sex, marital status, education, previous wage level). Note that wages are reported in hourly and weekly values but this reporting is inconsistent across observations. In other words, though most individuals (4600/6198) report their wage in both units, 270 report only hourly and 1328 report only weekly. We reconcile this by converting reported hourly wages to weekly wages, where weekly values are not reported. The data used below is from annual survey responses between 2000-2025. We use the supplement sample weights in all results below. In the 
We note where the sample has been trimmed for outliers (wage ratio between [0.25, 2] and unemployment duration less than 96 weeks (\~24 months).

Below, we outline the data cleaning procedure, provide descriptive figures and statistics, outline the econometric estimation strategy, provide regression results using the raw sample and reweighted samples addressing selection issues and non-uniformity, and provide information on the representativeness of the raw sample. The sample is non-uniform in unemployment duration (less observations are observed for higher values of unemployment duration). We employ three methods of reweighting to address these selection issues (Heckman Selection correction, entropy-balancing, and propensity score matching) to deal with representativeness issues of across values of unemployment durations. These re-weighting and sample balancing methods confirm the directionality of the regression results in the non-uniform sample, providing greater confidence in the triangulated reservation wage adjustment rate.

Overall, we find that individuals accept a \~1-percentage point decrease in the wage ratio per additional month of unemployment. Variations using model reweighting, different samples, combinations of control variables, reported hourly and weekly wage ratios do not seem to affect the result. However, the data seems to follow a non-linear relationship (we see little satisficing until around \~12 months of unemployment) after which the wage ratio begins to decrease. Individuals seem to accept a below-1 relative wage ratio (current wage:wage at lost job) following a year of unemployment.

**Important Considerations/Limitations:**

1.  **Displaced worker classification as outlined above.** We do not distinguish between workers in our model that are voluntarily or involuntarily separated from their jobs. Therefore, the displaced worker classification outlined above does not represent individuals unemployed voluntarily. 
2.  **The reported 'current wage' is not necessarily the realised wage post-re-employment.** Individuals report the wage at their lost job, the amount of time unemployed until they were re-employed, and the wage they hold at their current job. However, it is not indicated whether the current job is the same job as the first they were re-employed at. As such, there is uncertainty in the measurement of this outcome as an accepted wage that is relatively low compared to an individual's previous wage might be a temporary reality rather than a true re-employment wage (i.e., an individual finding stop-gap employment).
3.  **Outcome variable:** The outcome variable does not adequately handle fundamentally different wage scales (i.e., a 10% wage increase would likely be more or less devastating depending on the initial wage level). We control for wage levels in various specifications listed below. We find that controlling for wage levels does not significantly impact our results.

```{r setup_cps, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8,
  out.width = '0.9\\linewidth',
  echo = FALSE,
  dev = "ragg_png",
  dpi = 300
)
```


```{r packages, echo = FALSE, warning = FALSE, message = FALSE}

library(ggplot2)
library(extrafont)
extrafont::loadfonts(quiet = TRUE)

# Global wrap_width for str_wrap
wrap_width_fixed = 60

# theme for plotting
library(ggtext)
library(patchwork)
library(ipumsr)
library(tidyverse)
library(haven)
library(here)
library(janitor)
library(modelsummary)
library(broom)
library(knitr)
library(performance)
library(WeightIt)
library(survey)
library(gt)
library(qqplotr)
library(cobalt)
library(sampleSelection)
library(extrafont)
extrafont::loadfonts(quiet = TRUE)
source(here('code/formatting/plot_dicts.R'))

```

<!-- ## Data cleaning -->

<!-- Feel free to ignore this code chunk immediately below - included for now for transparency in case you spot issues.  -->
<!-- I include it for your info on binning and outlier trimming. -->

```{r disc_data, warning = FALSE, echo = FALSE}

# From the original dataset, I include only those that reported having lost a 
# FT job in the last three years
df <- readRDS(here("data/behav_params/cps_displaced_worker_supplement/cps_disp_filtered.RDS")) %>% 
  select(hwtfinl, cpsid, wtfinl, age, sex, race, marst, educ, 
         # age, sex, race, marital status, educational attainment
         dwsuppwt, # Survey weight
         dwyears, # Years worked at lost job
         dwben, # Received unemployment benefits
         dwexben, # Exhausted unemployment benefits
         dwlastwrk, # Time since worked at last job
         dwweekc, # Weekly earnings at current job
         dwweekl, # Weekly earnings at lost job
         dwwagel, # Hourly earnings at lost job
         dwwagec, # Hourly wage at current job
         dwhrswkc, # Hours worked each week at current job
         dwresp, # Eligibility and interview status for Displaced Wrkr Supplement
         # Interestingly the unemployment duration is not directly linked to 
         # CURRENT job and we cannot see the wage of the start of the next job...
        # thought this feels problematic, it does indicate more accurately the 
        # ultimate "recovered" wage...will need to declare as a limitation 
        # but also not completely indefensible
         dwwksun) %>%  # Number of weeks not working between between end of lost
         # or left job and start of next job
  # I remove anyone who is Not in Universe (99) and declaring greater than 160 
  # weeks unemployed between jobs
filter(dwhrswkc != 99 & dwwksun <= 160) %>% 
  # Replacing NIU values with NA values
  mutate(dwwagel = ifelse(round(dwwagel) == 100, NA, dwwagel),
         dwwagec = ifelse(round(dwwagec) == 100, NA, dwwagec),
         dwweekl = ifelse(round(dwweekl) == 10000, NA, dwweekl),
         dwweekc = ifelse(round(dwweekc) == 10000, NA, dwweekc),
         # dwwage_rec_l = ifelse(is.na(dwagel) & !is.na(dweekl) ~ dwweekl),
         # dwweekc = ifelse(round(dwweekc) == 10000, NA, dwweekc),
         # Binning educational categories
         educ_cat = factor(case_when(educ %in% c(1) ~ NA, # (NIU)
                              educ > 1 & educ <= 71 ~ "Less than HS", # Includes 
                                  # "None" - Grade 12 no diploma 
                                  # (8 subcategories (grade 1-11 etc))
                              educ %in% c(73, 81) ~ "HS Diploma", # Includes 
                                  # "High school Diploma or equivalent" and 
                                  # "some college, but no degree"
                              educ %in% c(91, 92) ~ "Associate's", # Include 
                                  # "[Associate's degree, occupational/vocational 
                                  # program]" and "Associate's 
                                  # [Associate's degree, academic program]"
                              educ %in% c(111) ~ "Bachelor's",#Bachelor's degree
                              educ > 111 ~ "Postgraduate Degree" # Includes 
                                  # Master's, Professional School & Doctorate
                              ), , levels = c("Less than HS", "HS Diploma", 
                                              "Associate's", "Bachelor's", 
                                              "Postgraduate Degree")),
         # Marital status to binary indicator
         marst = case_when(marst == 1 ~ 1, # Married with a present spouse
                           # Might consider dividing this differently
                           TRUE ~ 0), # Married with absent spouse, separated, 
                          # divorced, widowed, never married/single
         
         female = sex == 2, # gender to 0,1 values
         white = race == 100, # race to higher-level categories w binary values
         black = race == 200,
         mixed = race %in% c(801, 802, 803, 804, 805, 
                             806, 810, 812, 813, 820, 830),
         aapi = race %in% c(650, 651, 652, 808, 809),
         native = race == 300
         # age is continuous which seems fine...binning likely unnecessary
         ) %>% 

  mutate(ratio_wage = dwwagec/dwwagel, # Ratio of hourly wage current:lost job
         ratio_weekly = dwweekc/dwweekl, # Ratio of wkly wage of current:lost job
         # Reconciling missing reporting between weekly and hourly wage. 
         # Take either the min, max or mean value. 
         ratio_reconciled_min = case_when(is.na(ratio_wage) ~ ratio_weekly, 
                                          is.na(ratio_weekly) ~ ratio_wage, 
                                          TRUE ~ pmin(ratio_weekly, ratio_wage)), 
         ratio_reconciled_max = case_when(is.na(ratio_wage) ~ ratio_weekly, 
                                          is.na(ratio_weekly) ~ ratio_wage, 
                                          TRUE ~ pmax(ratio_weekly, ratio_wage)), 
         ratio_reconciled_mean = case_when(is.na(ratio_wage) ~ ratio_weekly, 
                                          is.na(ratio_weekly) ~ ratio_wage, 
                                          TRUE ~ rowMeans(across(c(ratio_wage, 
                                                                   ratio_weekly)), 
                                                          na.rm = TRUE)), 
         # Create monthly unemployment duration for continuous
         dwmosun = floor(dwwksun/4),
         dwmosun2 = dwmosun^2,
         dwmosun3 = dwmosun^3,
         # Unemployment duration:
                  # (reported as time between lost job and start of next job)
         # I bin in...
           # monthly intervals (4 weeks) from 1-6 months
           # quarterly intervals (12 weeks) from 7 mos-1 year
           # half-year interval from 1-2.5 years
           # single bin for anyone about 120 weeks
         dwwksun_bin = case_when(
           # Monthly intervals (4 weeks) from 1-6 months
           dwwksun <= 4 ~ 1, #"Less than 4 weeks",
                                 dwwksun > 4 & dwwksun <= 8 ~ 2,
                                 dwwksun > 8 & dwwksun <= 12 ~ 3,
                                 dwwksun > 12 & dwwksun <= 16 ~ 4, 
                                 dwwksun > 16 & dwwksun <= 20 ~ 5,
                                 dwwksun > 20 & dwwksun <= 24 ~ 6,
                                 # Quarterly Intervals (12 wks) from 6+ mos-1 yr
                                 dwwksun > 24 & dwwksun <= 36 ~ 7,
                                 dwwksun > 36 & dwwksun <= 48 ~ 8, 
                                 # Half-year Intervals (24 weeks) from 1-2.5 yrs
                                 dwwksun > 48 & dwwksun <= 72 ~ 9, 
                                 dwwksun > 72 & dwwksun <= 96 ~ 10, 
                                 dwwksun > 96 & dwwksun <= 120 ~ 11, 
                                 # Anyone above-recall this is capped at 160 wks 
                                  # as per filter above
                                 dwwksun > 120 ~ 12),
         # Bin labels
         dwwksun_bin_labs = case_when(dwwksun_bin == 1 ~ "<= 1 mo.", #"< 4 wks",
                                 dwwksun_bin == 2 ~ "1-2 mos.",
                                 dwwksun_bin == 3 ~ "2-3 mos.",
                                 dwwksun_bin == 4 ~ "3-4 mos.", 
                                 dwwksun_bin == 5 ~ "4-5 mos.",
                                 dwwksun_bin == 6 ~ "5-6 mos.",
                                 # Quarterly Intervals (12 wks) from 6+ mos-1 yr
                                 dwwksun_bin == 7 ~ "6-9 mos.",
                                 dwwksun_bin == 8 ~ "9-12 mos.", 
                                 # Half-year Intervals (24 wks) from 1-2.5 years
                                 dwwksun_bin == 9 ~ "12-18 mos.", 
                                 dwwksun_bin == 10 ~ "18-24 mos.", 
                                 dwwksun_bin == 11 ~ "24-30 mos.", 
                                 # Anyone above-recall this is capped at 160 wks
                                 # as per filter above
                                 dwwksun_bin == 12 ~ "30+ mos."),
         log_ratio_wage = log(ratio_wage),
         log_ratio_weekly = log(ratio_weekly),
         # I clip the sample to an accepted wage ratio between [0.5, 2] 
         # and less than 96 weeks of unemployment
         clipped_sample_hwage = 
           ratio_wage >= 0.5 & ratio_wage <= 2 & dwwksun_bin < 11,
         clipped_sample_wwage = 
           ratio_weekly >= 0.5 & ratio_weekly <= 2  & dwwksun_bin < 11,
         clipped_sample_rec_min = 
           ratio_reconciled_min>=0.5 & ratio_reconciled_min<=2 & dwwksun_bin<11,
         clipped_sample_rec_max = 
           ratio_reconciled_max>=0.5 & ratio_reconciled_max<=2 & dwwksun_bin<11,
         clipped_sample_rec_mean = 
           ratio_reconciled_mean>=0.5 & ratio_reconciled_mean<=2 & dwwksun_bin<11)


```

# Descriptives

All descriptives below use the Displaced Worker Sample Weights.

Histogram: sample is skewed (see reweighting alternatives at end of document).

Box plots: Looking at the reported wage ratios in weekly and hourly values, the mean is fixed near 1 until \>12 mos of unemployment in hourly wage reporting.
In weekly wage reporting, the ``satisficing" seems to start earlier in unemployment duration (sample size is larger for weekly reporting - might be worth focusing on those wages).

Scatter plot: I fit a linear and spline fit to the scatted plot of the wage ratio to unemployment duration before using the regression.
Indicates decline in the wage ratio with unemployment duration that has a potentially non-linear fit.

```{r disc_descriptives, echo=FALSE, warning = FALSE, fig.height = 8, fig.width = 10, message = FALSE}
hist1 <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot() + 
  geom_histogram(aes(x = dwwksun, weight = dwsuppwt), fill = "lightcoral") +
  labs(y = "Count", x = "Continuous Unemployment Duration", title = "Continuous Unemployment Duration") +
  common_theme

# Extract unique values and labels
breaks <- sort(unique(df$dwwksun_bin))
labels <- df %>%
  distinct(dwwksun_bin, dwwksun_bin_labs) %>%
  arrange(dwwksun_bin) %>%
  pull(dwwksun_bin_labs)

hist2 <- df %>%
    filter(clipped_sample_hwage) %>% 
  ggplot() +
  geom_bar(aes(x = dwwksun_bin, weight = dwsuppwt), fill = "lightblue") +
  scale_x_continuous(
    breaks = breaks,
    labels = labels
  ) +
  labs(y = "Count", x = "Continuous Unemployment Duration", title = "Binned Unemployment Duration") +
  common_theme

(hist1 / hist2) + plot_annotation(title = "Reported unemployment duration between lost job and next job", subtitle = "Observations weighted by Displaced Worker Supplement Weights. Annual data from 2000-2025. Exclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)
################################################################################
################################################################################

bp1 <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot(aes(x = as.factor(dwwksun_bin), y = ratio_wage)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwwksun_bin)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Hourly Wage Ratio",
       x = "Unemployment Duration (binned)",
       y = "Hourly Wage at Current Job:Hourly Wage at Lost Job") +
  ylim(0,2.5) +
    theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels = labels) +
  common_theme +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45))

bp2 <- df %>%
  filter(clipped_sample_wwage) %>%
  ggplot(aes(x = as.factor(dwwksun_bin), y = ratio_weekly)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwwksun_bin)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Weekly Wage Ratio",
       x = "Unemployment Duration (binned)",
       y = "Weekly Wage at Current Job:Weekly Wage at Lost Job") +
  common_theme +
  ylim(0,2.5) +
  theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels = labels)+
  theme(legend.position = "none", axis.text.x = element_text(angle = 45))

bp3 <- df %>%
  filter(clipped_sample_rec_min) %>%
  ggplot(aes(x = as.factor(dwwksun_bin), y = ratio_reconciled_min)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwwksun_bin)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Wage Ratio - Reconciled with min", y = "Accepted:Lost Wage Ratio", x = "Unemployment Duration (binned)") +
  common_theme +
  ylim(0,2.5) +
    theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels = labels)+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

bp4 <- df %>%
  filter(clipped_sample_rec_max) %>%
  ggplot(aes(x = as.factor(dwwksun_bin), y = ratio_reconciled_max)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwwksun_bin)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Wage Ratio - Reconciled with max", y = "", x = "Unemployment Duration (binned)") +
  common_theme + 
  ylim(0,2.5) +  
  theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels = labels)+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

bp5 <- df %>%
  filter(clipped_sample_rec_mean) %>%
  ggplot(aes(x = as.factor(dwwksun_bin), y = ratio_reconciled_mean)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwwksun_bin)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Wage Ratio - Reconciled with mean", y = "", x = "Unemployment Duration (binned)") +
  common_theme + 
  ylim(0,2.5) +
    theme(plot.title=element_text(hjust=0.5)) +
  scale_x_discrete(labels = labels)+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

bp_cont <- df %>%
  filter(clipped_sample_rec_min) %>%
  mutate(dwmosun_2mo = ceiling(dwmosun/2)*2) %>% 
  ggplot(aes(x = as.factor(dwmosun_2mo), y = ratio_reconciled_min)) +
  geom_boxplot(aes(weight = dwsuppwt, fill = as.factor(dwmosun_2mo)), alpha = 0.3)+
  geom_hline(yintercept = 1, color = "darkblue", linetype = "dashed") +
  labs(title = "Wage Ratio - Reconciled with min", 
       x = "Unemployment Duration (binned 2-month intervals)",
       y = "Wage Ratio - reconciled with min") +
  common_theme + 
  ylim(0,2.5) +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(legend.position = "none")

(bp1 + bp2) + plot_annotation(title = "Reported ratio of current wage to lost wage by unemployment duration", subtitle = "Observations weighted by Displaced Worker Supplement Weights.\nAnnual data from 2000-2025.\nExclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)

(bp3 + bp4 + bp5) + plot_annotation(title = "Reported ratio of current wage to lost wage by unemployment duration", subtitle = "Observations weighted by Displaced Worker Supplement Weights.\nAnnual data from 2000-2025.\nExclude observations reporting > 96 weeks of unemployment.\nIn many cases, only hourly OR weekly wages are reported.\nTo be able to combine information on all workers to one value,we select the present statistic for those missing one and \n retain either the minimum, maximum, or mean of the hourly versus weekly wage for those reporting both.", theme = plot_annotation_theme)

# (bp3) + plot_annotation(title = "Reported ratio of current wage to lost wage by unemployment duration", subtitle = "Observations weighted by Displaced Worker Supplement Weights. Annual data from 2000-2025.\nExclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)

bp_cont + plot_annotation(title = "Reported ratio of current wage to lost wage by unemployment duration", subtitle = "Observations weighted by Displaced Worker Supplement Weights.\nAnnual data from 2000-2025.\nExclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)

```

```{r disc_spline, echo=FALSE, warning = FALSE, fig.height = 8, fig.width = 10, message = FALSE}

lin <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot(aes(x = dwmosun, y = ratio_wage, weight = dwsuppwt))+
  geom_jitter() +
  geom_smooth(method = "lm") +
    theme(plot.title=element_text(hjust=0.5)) +
  labs(title = "Linear fit", y = "Hourly Wage Ratio", x = "Unemployment Duration (mos.)") +
  common_theme 

spline <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot(aes(x = dwmosun, y = ratio_wage, weight = dwsuppwt))+
  geom_jitter() +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 3)) +
    theme(plot.title=element_text(hjust=0.5)) +
  labs(title = "Spline fit", y = "Hourly Wage Ratio", x = "Unemployment Duration (mos.)") +
  common_theme

(lin + spline) + plot_annotation(title = "Linear and spline fit to scatter plot of wage ratio vs. unemployment duration in months.", subtitle = str_wrap("Observations weighted by Displaced Worker Supplement Weights. Annual data from 2000-2025. Exclude observations reporting > 96 weeks of unemployment and wage ratios below 0.5 and above 2.", width = wrap_width_fixed), theme = plot_annotation_theme)

```

# Regressions (non-uniform sample)

Next, before correcting for the non-uniformity of the sample (i.e., that there are less observations present for higher unemployment durations), we employ the following econometric specificaitons (with various modifications to sample and control variables).\\

$W_{i} = \alpha_{i} + \beta_{1} d_{i} + \beta_{2}UI_{i} + \beta_{3}X_{i} + \epsilon_{i}$

where $W_{i}$: Ratio of accepted wage to wage at lost job (hourly values).

$d_{i}$: Unemployment duration in continuous (months) or binned values.

$UI_{i}$: Control variable for having used or exhausted unemployment benefits.

$X_{i}$: Vector of control variables (sex, age, race, marital status, education level, and previous wage level).

We present and compare 48 variations on the above model present with all combinations of the following:

-   **Continuous vs. Discrete Treatment Variable (2 alternatives):** Continuous (monthly) versus binned unemployment duration.

-   **w. UI vs w. Exhausted UI (3 alternatives):** The survey includes a variable for whether individuals USE and/or EXHAUST unemployment benefits. We run the regressions without these UI controls, with the control for having used UI, or with the control for having exhausted UI.

-   **w. Controls (2 alternatives):** With or without additional demographic controls (sex, age, race, married, education).

-   **w. Wage Level (2 alternatives):** With or without wage level of lost job to control for income and the relationship between wage levels and the outcome wage ratio itself.

-   **Outlier clipped sample (2 alternatives):** Either remove outliers where the wage ratio is within [0.25, 2.5] and reported unemployment duration is below 96 weeks (\~ 2 years), or employ the raw sample.

In each regression table, we include the full set of coefficients to allow for examination of the regression coefficients on the controls as well as the principal variables of interest. In each table, we highlight $\beta_{1}$ as this is the main regression coefficient of interest. We employ the *check_model()* function from the *performance* package in R to display visual checks of various model assumptions. 


```{r disc_non_uniform_regs, echo=FALSE, warning = FALSE, out.width="75%"}

controls <- " + female + age + white + black + mixed + marst + educ_cat"
reg_forms <- c("Cont." = "dwmosun",
               "Cont. w. UI" = "dwmosun + dwben",
               "Cont. w. exhausted UI" = "dwmosun + dwexben",
               "Cont. Sq" = "dwmosun + dwmosun2 ",
               "Cont. Sq w. UI" = "dwmosun + dwmosun2 + dwben",
               "Cont. Sq w. exhausted UI" = "dwmosun + dwmosun2 + dwexben",
               "Disc." = "dwwksun_bin",
               "Disc. w. UI" = "dwwksun_bin + dwben",
               "Disc. w. exhausted UI" = "dwwksun_bin + dwexben")
reg_forms_controls <- paste0(reg_forms, controls)
names(reg_forms_controls) <- paste0(names(reg_forms), " w. controls")
reg_forms_full <- c(reg_forms, reg_forms_controls)

mod_list <- list()
for(rf in names(reg_forms_full)){
  #### HOURLY WAGE RATIO OF ACCEPTED TO PREVIOUS
  ## Unclipped sample
  mod_list[[rf]] <- lm(data = df, as.formula(paste0("ratio_wage ~ ", reg_forms_full[rf])), weights = dwsuppwt)

  ## Clipped sample
  mod_list[[paste0(rf, " (clipped)")]] <- df %>% 
    filter(clipped_sample_hwage) %>% 
    lm(data = ., as.formula(paste0("ratio_wage ~ ", reg_forms_full[rf])), weights = dwsuppwt)
  
  # #### WEEKLY WAGE RATIO OF ACCEPTED TO PREVIOUS
  # ## Unclipped sample
  # mod_list[[paste0("WWR ", rf)]] <-filter(df, ratio_weekly != Inf) %>% 
  # lm(data = ., as.formula(paste0("ratio_weekly ~ dwweekl + ", reg_forms_full[rf])), weights = dwsuppwt)
  # 
  # ## Clipped sample
  # mod_list[[paste0("WWR ", rf, " (clipped)")]] <- filter(df, ratio_weekly != Inf & clipped_sample_wwage) %>% 
  #   lm(data = ., as.formula(paste0("ratio_weekly ~ dwweekl + ", reg_forms_full[rf])), weights = dwsuppwt)
}

# output_pretty <- function(mods, highlightrows = FALSE, title = NULL){
#   modelsummary(mods, gof_omit = c("Log.Lik.|BIC|AIC"), stars = TRUE, coef_rename = coef_labs,
#                output = "kableExtra", title = title) %>%
#     kableExtra::row_spec(row = highlightrows, background = "lightblue") %>% 
#     kable(format = "latex")
# }

coef_labs = c("dwben" = "Received Unemployment Compensation",
               "dwexben" = "Exhausted Unemployment Compensation",
               "marst" = "Married",
               "femaleTRUE" = "Female",
               "educ_catBachelor's" = "Bachelor's Degree",
               "educ_catHS Diploma" = "High School",
               "educ_catLess than HS" = "Less than HS",
               "educ_catAssociate's" = "Associate's Degree",
               "educ_catPostgraduate Degree" = "Postgraduate Degree",
               "whiteTRUE" = "White",
               "blackTRUE" = "Black",
               "mixedTRUE" = "Mixed",
               "age" = "Age",
               "dwwagel" = "Hourly Wage of Lost Job",
               "dwmosun" = "Unemployment Duration (Months)",
               "dwmosun2" = "Unemployment Duration (MonthsÂ²)",
               "dwwksun" = "Unemployment Duration (Cont.)",
               "dwwksun_bin" = "Unemployment Duration (Binned)",
               "(Intercept)" = "Intercept",
                # Relabelled for Heckman result below
               "XO(Intercept)" = "Intercept",
               "XOdwmosun" = "Unemployment Duration (Months)",
               "XOdwben" = "Received Unemployment Compensation",
               "XOdwexben" = "Exhausted Unemployment Compensation",
               "XOmarst" = "Married",
               "XOfemaleTRUE" = "Female",
               "XOeduc_catBachelor's" = "Bachelor's Degree",
               "XOeduc_catHS Diploma" = "High School",
               "XOeduc_catLess than HS" = "Less than HS",
               "XOeduc_catAssociate's" = "Associate's Degree",
               "XOeduc_catPostgraduate Degree" = "Postgraduate Degree",
               "XOwhiteTRUE" = "White",
               "XOblackTRUE" = "Black",
               "XOmixedTRUE" = "Mixed",
               "XOage" = "Age",
               "XOdwwagel" = "Hourly Wage of Lost Job",
               "XOdwwksun" = "Unemployment Duration (Cont.)",
               "XOdwwksun_bin" = "Unemployment Duration (Binned)",
              "imrData$IMR1" = "Inverse Mills Ratio"
               )


options(modelsummary_factory_latex = "kableExtra")
output_pretty <- function(mods, highlightrows = NULL, title = NULL) {
  modelsummary(
    mods,
    gof_omit = c("Log.Lik.|BIC|AIC"),
    stars = TRUE,
    coef_rename = coef_labs,
    output = "latex",
    title = title,
    escape = TRUE
  ) %>%
    kableExtra::row_spec(row = highlightrows, background = "yellow!20") %>%
    kableExtra::kable_styling(latex_options = "scale_down")
}


################################################################################
################################################################################
########## TRYING WITH WAGE LEVEL ADDED IN ###########

mod_list2 <- list()
for(rf in names(reg_forms_full)){
  #### HOURLY WAGE RATIO OF ACCEPTED TO PREVIOUS
  ## Unclipped sample
  mod_list2[[rf]] <- lm(data = df, as.formula(paste0("ratio_wage ~ dwwagel + ", reg_forms_full[rf])), weights = dwsuppwt)

  ## Clipped sample
  mod_list2[[paste0(rf, " (clipped)")]] <- df %>% 
    filter(clipped_sample_hwage) %>% 
    lm(data = ., as.formula(paste0("ratio_wage ~ dwwagel + ", reg_forms_full[rf])), weights = dwsuppwt)
  
  # #### WEEKLY WAGE RATIO OF ACCEPTED TO PREVIOUS
  # ## Unclipped sample
  # mod_list[[paste0("WWR ", rf)]] <-filter(df, ratio_weekly != Inf) %>% 
  # lm(data = ., as.formula(paste0("ratio_weekly ~ dwweekl + ", reg_forms_full[rf])), weights = dwsuppwt)
  # 
  # ## Clipped sample
  # mod_list[[paste0("WWR ", rf, " (clipped)")]] <- filter(df, ratio_weekly != Inf & clipped_sample_wwage) %>% 
  #   lm(data = ., as.formula(paste0("ratio_weekly ~ dwweekl + ", reg_forms_full[rf])), weights = dwsuppwt)
}


```

```{r dics_newdata, echo = FALSE}
# Dataframe needed for predictions

newdata <- data.frame(
  dwmosun = seq(0, 36, by = 1),  # months of unemployment
  female = as.logical(round(mean(df$female))),                   # male
  age = median(df$age, na.rm = TRUE),
  white = as.logical(round(mean(df$white))),
  black = as.logical(round(mean(df$black))),
  mixed = as.logical(round(mean(df$mixed))),
  marst = round(mean(df$marst)),
  educ_cat = factor("HS Diploma", levels = levels(df$educ_cat))
) %>% 
  mutate(dwmosun2 = dwmosun^2,
         dwmosun3 = dwmosun^3)

```

Across all models in the tables below we see a consistently negative coefficient on unemployment duration (\~0.7-1 percentage point increase in the wage ratio for each additional month spent in unemployment). If we look more closely at the performance of our model with continuous unemployment duration, UI use (not exhaustion), all controls, wage levels, and outlier correction we see that the model performs passably across various diagnostic tests.

```{r disc_reg1, echo = FALSE, warning = FALSE, message = FALSE, results='hide', fig.keep='last'}

p <- invisible({mod_list2[['Cont. w. UI w. controls (clipped)']] %>% 
  check_model() %>% 
  plot()})

(p & common_theme) + 
  plot_annotation(title = 'Continuous U Duration. w. UI Control w. demographic controls (clipped sample)', theme = plot_annotation_theme)

```

## Continuous UE Duration 

Continuous UE duration treatment is reported in monthly values.
A one-unit increase in the treatment variable = 1 additional month of unemployment.

```{r disc_reg2, echo = FALSE, message = FALSE, warning = FALSE}

output_pretty(mod_list[grepl("Cont", names(mod_list)) & grepl("clipped", names(mod_list))], highlightrows = 3, title = "Continuous UE Duration w.o Wage Level Control (Clipped Sample)")

output_pretty(mod_list[grepl("Cont", names(mod_list)) & !grepl("clipped", names(mod_list))], highlightrows = 3, title = "Continuous UE Duration w.o Wage Level Control (Full Sample)")

```


```{r disc_reg3, echo = FALSE, message = FALSE, warning = FALSE}
lm1 <- lm(ratio_wage ~ dwmosun + female + age + white + black + mixed + marst + educ_cat, data = df, weights = dwsuppwt)
lm2 <- lm(ratio_wage ~ dwmosun + dwmosun2 + female + age + white + black + mixed + marst + educ_cat, data = df, weights = dwsuppwt)
lm3 <- lm(ratio_wage ~ dwmosun + dwmosun2 + dwmosun3 + female + age + white + black + mixed + marst + educ_cat, data = df, weights = dwsuppwt)

lm_preds  <- as.data.frame(predict(lm1,  newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("lm_preds_",.))
lm_preds2 <- as.data.frame(predict(lm2, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("lm_preds2_",.))
lm_preds3 <- as.data.frame(predict(lm3, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("lm_preds3_",.))

lm_full <- cbind(lm_preds, lm_preds2, lm_preds3)

lm_full %>% 
  ggplot(aes(x = 0:(nrow(lm_full)-1))) +
    # Model 1
    geom_line(aes(y = lm_preds_fit, color = "Linear"), linewidth = 1) +
    geom_ribbon(aes(ymin = lm_preds_lwr, ymax = lm_preds_upr, fill = "Linear"), alpha = 0.2) +
  
    # Model 2
    geom_line(aes(y = lm_preds2_fit, color = "Quadratic"),  linewidth = 1) +
    geom_ribbon(aes(ymin = lm_preds2_lwr, ymax = lm_preds2_upr, fill = "Quadratic"),  alpha = 0.2) +
  
    # Model 3
    geom_line(aes(y = lm_preds3_fit, color = "Cubic"), linewidth = 1) +
    geom_ribbon(aes(ymin = lm_preds3_lwr, ymax = lm_preds3_upr, fill = "Cubic"), alpha = 0.2) +
  scale_color_manual(
    name = "Model", 
    values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
  ) +
  scale_fill_manual(
    name = "Model", 
    values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
  ) +
    labs(
      title = "Predicted Wage Ratios by Unemployment Duration",
      subtitle = "From non-reweighted regressions: linear, quadratic, and cubic specifications",
      x = "Unemployment Duration (months)",
      y = "Predicted Wage Ratio"
    ) +
    common_theme +
  ylim(0.3, 1.1)

```

```{r disc_reg4, echo = FALSE}

output_pretty(mod_list2[grepl("Cont", names(mod_list)) & grepl("clipped", names(mod_list))], highlightrows = c(3,5), title = "Continuous UE Duration w. Wage Level Control (Clipped Sample)")

output_pretty(mod_list2[grepl("Cont", names(mod_list)) & !grepl("clipped", names(mod_list))], highlightrows = c(3,5), title = "Continuous UE Duration w. Wage Level Control (Full Sample)")

```

## Binned UE Duration 

Binned UE duration treatment is reported in bins as indicated in the box plots and code cleaning above.

```{r disc_reg5, echo = FALSE}

output_pretty(mod_list[grepl("Disc", names(mod_list)) & grepl("clipped", names(mod_list))], highlightrows = 3, title = "Binned UE Duration w.o Wage Level Control (Clipped Sample)")

output_pretty(mod_list[grepl("Disc", names(mod_list)) & !grepl("clipped", names(mod_list))], highlightrows = 3, title = "Binned UE Duration w.o Wage Level Control (Full Sample)")

```

```{r disc_reg6, echo = FALSE}

output_pretty(mod_list2[grepl("Disc", names(mod_list)) & grepl("clipped", names(mod_list))], highlightrows = c(3,5), title = "Binned UE Duration w. Wage Level Control (Clipped Sample)")

output_pretty(mod_list2[grepl("Disc", names(mod_list)) & !grepl("clipped", names(mod_list))], highlightrows = c(3,5), title = "Binned UE Duration w. Wage Level Control (Full Sample)")

```

# Additional Considerations 

Next, we provide results for the econometric specifications listed above with better balanced survey samples. We outline the various procedures employed for dealing with selection issues and non-uniformity in the sample.

## Selection Issues with Non-Random Sample 

One of the challenges with this data is that the sample grows significantly smaller for higher reported of unemployment duration (see scatter plots in section above). Therefore, we re-weight our survey sample (beyond the census weights already employed) to ensure population similarity across bins. More precisely, we employ propensity score matching using a generalised linear model, entropy-balancing, and Heckman selection correction.
 
Overall, we find the econometric results reported earlier to be consistent across these implementations, with the coefficients on unemployment duration remaining somewhat stable. 

### Entropy Balancing

First, entropy balancing simply reweights observations to ensure population matching across the key dependent variable.

```{r disc_eb1, warning = FALSE, fig.height = 8, fig.width = 10}
# Apply entropy balancing using dwsuppwt sample weights
# Reweight according to observable characteristics using "ebalance" 
eb <- weightit(
  formula = dwmosun ~ female + age + white + black + mixed + marst + educ_cat,
  data = df,
  method = "ebalance",
  s.weights = df$dwsuppwt
)

var_labs_love = c(
        "female" = "Female",
        "age" = "Age",
        "white" = "White",
        "black" = "Black",
        "mixed" = "Mixed",
        "marst" = "Married",
               "educ_cat_Bachelor's" = "Bachelor's Degree",
               "educ_cat_Associate's" = "Associate's Degree",
               "educ_cat_HS Diploma" = "High School",
               "educ_cat_Less than HS" = "Less than HS",
               "educ_cat_Postgraduate Degree" = "Postgraduate Degree"
               )

# All covariates are balanced at the mean with tight threshold
#bal.tab(eb, stats = c("m", "v"), thresholds = c(m = .001))
love.plot(eb, thresholds = .001,  var.names = var_labs_love) + 
  labs(subtitle = str_wrap("Love plot of adjusted and unadjusted covariates including relevant mean threshold 0.01 using entropy balancing reweighting. All covariates are balanced at the mean with a threshold of 0.001.", width = wrap_width_fixed)) +
  common_theme

# Add the new weights to the dataframe
df$eb_weight <- eb$weights

# Run weighted linear regression using entropy-balanced weights
mod_eb_reweight <- lm(
  formula = ratio_wage ~ dwmosun + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = eb_weight
)

mod_eb_reweight2 <- lm(
  formula = ratio_wage ~ dwmosun + dwmosun2 + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = eb_weight
)

mod_eb_reweight3 <- lm(
  formula = ratio_wage ~ dwmosun + dwmosun2 + dwmosun3 + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = eb_weight
)


# Extract prediction intervals as data frames
eb_preds  <- as.data.frame(predict(mod_eb_reweight,  newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("eb_preds_",.))
eb_preds2 <- as.data.frame(predict(mod_eb_reweight2, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("eb_preds2_",.))
eb_preds3 <- as.data.frame(predict(mod_eb_reweight3, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("eb_preds3_",.))

eb_full <- cbind(eb_preds, eb_preds2, eb_preds3)
```


```{r disc_eb2, warning = FALSE}

eb_full %>% 
  ggplot(aes(x = 0:(nrow(eb_full)-1))) +
    # Model 1
    geom_line(aes(y = eb_preds_fit, color = "Linear"), linewidth = 1) +
    geom_ribbon(aes(ymin = eb_preds_lwr, ymax = eb_preds_upr, fill = "Linear"), alpha = 0.2) +
  
    # Model 2
    geom_line(aes(y = eb_preds2_fit, color = "Quadratic"), linewidth = 1) +
    geom_ribbon(aes(ymin = eb_preds2_lwr, ymax = eb_preds2_upr, fill = "Quadratic"), alpha = 0.2) +
  
    # Model 3
    geom_line(aes(y = eb_preds3_fit, color = "Cubic"), linewidth = 1) +
    geom_ribbon(aes(ymin = eb_preds3_lwr, ymax = eb_preds3_upr, fill = "Cubic"), alpha = 0.2) +
    scale_color_manual(
      name = "Model", 
      values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
    ) +
    scale_fill_manual(
      name = "Model", 
      values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
    ) +
    labs(
      title = "Predicted Wage Ratios by Unemployment Duration (Entropy Balancing)",
      subtitle = "From EB-weighted regressions: linear, quadratic, and cubic specifications",
      x = "Unemployment Duration (months)",
      y = "Predicted Wage Ratio"
    ) +
    common_theme +
  ylim(0.3, 1.1)
    
```

#### Diagnostic Tests for Entropy-balanced Reweighted Sample


```{r disc_eb3, echo = FALSE, warning = FALSE, message = FALSE, results='hide', fig.keep='last'}

(mod_eb_reweight %>% check_model()  %>% 
  plot() &
common_theme) + 
  plot_annotation(title = "Linear Specification", theme = plot_annotation_theme)

```



```{r disc_eb4, echo = FALSE, warning = FALSE, message = FALSE, results='hide', fig.keep='last'}

(mod_eb_reweight2 %>% check_model() %>% 
  plot() &
common_theme) +
  plot_annotation(title = "Quadratic Specification", theme = plot_annotation_theme)

```



```{r disc_eb5, echo = FALSE, warning = FALSE, message = FALSE, results='hide', fig.keep='last'}

(mod_eb_reweight3 %>% check_model() %>% 
  plot() &
common_theme) +
  plot_annotation(title = "Cubic Specification", theme = plot_annotation_theme)

```

### Propensity Score Weighting with GLM Estimator


```{r disc_glm1, warning = FALSE, fig.height = 8, fig.width = 10}

# More conventional propensity scoring with a GLM estimator
glm <- weightit(
  formula = dwmosun ~ female + age + white + black + mixed + marst + educ_cat,
  data = df,
  method = "glm",
  s.weights = df$dwsuppwt
)

# All covariates are balanced at the mean with less tight threshold (0.001, very few variables pass with glm esimator)
#bal.tab(glm, stats = c("m", "v"), thresholds = c(m = .01)) 
love.plot(glm, thresholds = .01, var.names = var_labs_love) + 
  geom_vline(aes(xintercept = 0.001), linestyle = "dotted", color = "grey70") + 
    geom_vline(aes(xintercept = -0.001), linestyle = "dotted", color = "grey70") + 
  labs(subtitle = str_wrap("Love plot of adjusted and unadjusted covariates including relevant mean threshold 0.01 using a GLM estimator.\nAll covariates except the binary indicator for having less than a HS degree level of education\nare balanced at the mean with a threshold of 0.01 (black dashed line)\n whereas very few variables pass at a tighter threshold 0.001 with the GLM estimator.", width = wrap_width_fixed)) +
  common_theme

```


#### Diagnostic Tests for Propensity Score Matching (GLM) Reweighted Sample


```{r disc_glm2, warning = FALSE, message = FALSE, results='hide', fig.keep='last'}

df$glm_weight <- glm$weights

mod_glm_reweight <- lm(
  formula = ratio_wage ~ dwmosun + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = glm_weight
)
mod_glm_reweight2 <- lm(
  formula = ratio_wage ~ dwmosun + dwmosun2 + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = glm_weight
)
mod_glm_reweight3 <- lm(
  formula = ratio_wage ~ dwmosun + dwmosun2 + dwmosun3 + female + age + white + black + mixed + marst + educ_cat,
  data = df,
  weights = glm_weight
)

(mod_glm_reweight %>% check_model() %>% 
  plot() &
common_theme) +
  plot_annotation(title = "Propensity Score Matching (GLM)", theme = plot_annotation_theme)

```

#### Predicted Reservation Wage using GLM Reweighted Sample

```{r disc_glm3, echo = FALSE}
# Extract prediction intervals as data frames
glm_preds  <- as.data.frame(predict(mod_glm_reweight,  newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("glm_preds_",.))
glm_preds2 <- as.data.frame(predict(mod_glm_reweight2, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("glm_preds2_",.))
glm_preds3 <- as.data.frame(predict(mod_glm_reweight3, newdata = newdata, interval = "confidence")) %>% rename_with(~paste0("glm_preds3_",.))

glm_full <- cbind(glm_preds, glm_preds2, glm_preds3)

glm_full %>% 
  ggplot(aes(x = 0:36)) +
    # Model 1
    geom_line(aes(y = glm_preds_fit, color = "Linear"), linewidth = 1) +
    geom_ribbon(aes(ymin = glm_preds_lwr, ymax = glm_preds_upr, fill = "Linear"), alpha = 0.1) +
  
    # Model 2
    geom_line(aes(y = glm_preds2_fit, color = "Quadratic"), linewidth = 1) +
    geom_ribbon(aes(ymin = glm_preds2_lwr, ymax = glm_preds2_upr, fill = "Quadratic"), alpha = 0.2) +
  
    # Model 3
    geom_line(aes(y = glm_preds3_fit, color = "Cubic"), linewidth = 1) +
    geom_ribbon(aes(ymin = glm_preds3_lwr, ymax = glm_preds3_upr, fill = "Cubic"), alpha = 0.2) +
    scale_color_manual(
      name = "Model", 
      values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
    ) +
    scale_fill_manual(
      name = "Model", 
      values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
    ) +
    labs(
      title = "Predicted Wage Ratios by Unemployment Duration (GLM)",
      subtitle = "From GLM-weighted regressions: linear, quadratic, and cubic specifications",
      x = "Unemployment Duration (months)",
      y = "Predicted Wage Ratio"
    ) +
    common_theme +
  ylim(0.3, 1.1)

```

### Heckman Selection

Another option is a Heckman Selection correction though I do not think this addresses the particular selection concern we have where there are simply less observations in longer unemployment durations.              

```{r disc_heckman1, warning = FALSE}
# Create selection indicator (1 if ratio_wage is observed)
df$observe_wage <- as.numeric(!is.na(df$ratio_wage))

# Define selection and outcome equations
selection_eq <- observe_wage ~ female + age + white + black + mixed + marst + educ_cat
outcome_eq  <- ratio_wage ~ dwmosun + female + age + white + black + mixed + marst + educ_cat
outcome_eq2 <- ratio_wage ~ dwmosun + dwmosun2 + female + age + white + black + mixed + marst + educ_cat
outcome_eq3 <- ratio_wage ~ dwmosun + dwmosun2 + dwmosun3 + female + age + white + black + mixed + marst + educ_cat 

# Run Heckman 
heckman_model <- selection(
  selection = selection_eq,
  outcome = outcome_eq,
  data = df,
  method = "2step",       
  weights = df$dwsuppwt   # Include weights from CPS
)

# Run Heckman 
heckman_model2 <- selection(
  selection = selection_eq,
  outcome = outcome_eq2,
  data = df,
  method = "2step",       
  weights = df$dwsuppwt   # Include weights from CPS
)

# Run Heckman 
heckman_model3 <- selection(
  selection = selection_eq,
  outcome = outcome_eq3,
  data = df,
  method = "2step",       
  weights = df$dwsuppwt   # Include weights from CPS
)

# Predict ratio_wage (corrected for selection)
preds <- predict(heckman_model, newdata = newdata, part = "outcome", type = "unconditional")
preds2 <- predict(heckman_model2, newdata = newdata, part = "outcome", type = "unconditional")
preds3 <- predict(heckman_model3, newdata = newdata, part = "outcome", type = "unconditional")


# Combine with original durations for plotting or inspection
newdata$predicted_ratio <- preds
newdata$predicted_ratio2 <- preds2
newdata$predicted_ratio3 <- preds3

ggplot(newdata, aes(x = dwmosun)) +
  geom_line(aes(y = predicted_ratio, color = "Linear")) +
  geom_line(aes(y = predicted_ratio2, color = "Quadratic")) +
  geom_line(aes(y = predicted_ratio3, color= "Cubic")) +
  scale_color_manual(
    name = "Model", 
    values = c("Linear" = "darkorchid", "Quadratic" = "orange", "Cubic" = "darkturquoise")
  ) +
    labs(
      title = "Predicted Wage Ratios by Unemployment Duration (Heckman Selection Correction)",
      subtitle = "From Heckman-corrected regressions: linear, quadratic, and cubic specifications",
      x = "Unemployment Duration (months)",
      y = "Predicted Wage Ratio"
    ) +
  common_theme

```


### Regression Results with Sample Reweighting


```{r disc_heckman2, echo = FALSE, warning = FALSE}
# All correction models together
list("Heckman Correction" = heckman_model$lm, "Entropy Balanced Reweight" = mod_eb_reweight, "GLM Reweight" = mod_glm_reweight) %>% output_pretty(highlightrows = 3)

```


```{r disc_heckman3, echo = FALSE, warning = FALSE}

ggplot() + 
  geom_line(data = lm_full, aes(x = 0:36, y = lm_preds_fit), color = "darkorchid") +
  geom_ribbon(data = lm_full, aes(x = 0:36, ymin = lm_preds_lwr, ymax = lm_preds_upr), fill = "darkorchid", alpha = 0.2) +
  geom_line(data = glm_full, aes(x = 0:36, y = glm_preds_fit), color = "darkturquoise") +
  geom_ribbon(data = glm_full, aes(x = 0:36, ymin = glm_preds_lwr, ymax = glm_preds_upr), fill = "darkturquoise", alpha = 0.2) +
  geom_line(data = eb_full, aes(x = 0:36, y = eb_preds_fit), color = "orange") +
  geom_ribbon(data = eb_full, aes(x = 0:36, ymin = eb_preds_lwr, ymax = eb_preds_upr), fill = "orange", alpha = 0.2) +
  geom_line(data = newdata, aes(x = 0:36, y = predicted_ratio)) +
  labs(x = "Unemployment Duration (months)", y = "Predicted Wage Ratio", title = "Predicted Wage Ratio vs. Unemployment Duration") +
  common_theme

res_wage_input <- select(lm_full, contains("lm_preds_")) %>% 
  cbind(select(glm_full, contains("glm_preds_"))) %>% 
  cbind(select(eb_full, contains('eb_preds_'))) %>% 
  #cbind(newdata[c('dwmosun', 'predicted_ratio')]) %>% 
  mutate(lm_se = (lm_preds_upr - lm_preds_lwr) / (2 * 1.96),
         glm_se = (glm_preds_upr - glm_preds_lwr) / (2 * 1.96),
         eb_se = (eb_preds_upr - eb_preds_lwr) / (2 * 1.96),
         dur_unemp = 0:36) %>% 
  #relocate(dwmosun) %>% 
  tibble()
  
set.seed(123)
# Simulate samples from normal distribution based on predicted means & SEs
simulate_values <- function(pred, se, dur_unemp, model_name, n = 1000) {
  tibble(
    dur_unemp = dur_unemp,
    model = model_name,
    sim_val = rnorm(n, mean = pred, sd = se)
  )
}

# Simulate for each model
sim_lm <- pmap_dfr(
  list(res_wage_input$lm_preds_fit, res_wage_input$lm_se, res_wage_input$dur_unemp),
  simulate_values,
  model_name = "LM"
)

sim_glm <- pmap_dfr(
  list(res_wage_input$glm_preds_fit, res_wage_input$glm_se, res_wage_input$dur_unemp),
  simulate_values,
  model_name = "GLM"
)

sim_eb <- pmap_dfr(
  list(res_wage_input$eb_preds_fit, res_wage_input$eb_se, res_wage_input$dur_unemp),
  simulate_values,
  model_name = "EB"
)

# Combine all simulated data
sim_all <- bind_rows(sim_lm, sim_glm, sim_eb)

# Plot: Violin plots of simulated predicted values
ggplot(sim_all, aes(x = factor(dur_unemp), y = sim_val, fill = model)) +
  geom_violin(position = position_dodge(width = 0.8), color = NA, width = 0.7, alpha = 0.7) +
  stat_summary(fun = mean, geom = "point", position = position_dodge(width = 0.8), 
               shape = 21, size = 1.5, color = "black", fill = "white") +
  labs(
    title = "Simulated Predicted Wage Ratio Distributions by Unemployment Duration",
    subtitle = "Violin plots from LM, GLM, and EB model predictions",
    x = "Unemployment Duration (months)",
    y = "Simulated Predicted Wage Ratio",
    fill = "Model"
  ) +
  common_theme +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "bottom"
  )  +
  scale_fill_brewer(palette = 'Dark2')

#res_wage_input %>% 
  #select(dur_unemp, contains("_fit"), contains("_se")) %>% 
  #write.csv(here('calibration_remote/data/res_wage_dists.csv'))
  #write.csv(here('data/behav_params/cps_displaced_worker_supplement/res_wage_dists.csv'))
#ggsave(here('data/behav_params/cps_displaced_worker_supplement/res_wage_dists.jpg'), dpi = 300, width = 11, height = 8)


```


### Job Tenure

We have information on the tenure spent at the last job which could impact the result.
This could speak to the ``adaptability" of individuals.
Wage ratio seems to decrease (although not sure if meaningfully) with tenure at previous job.

```{r, echo=FALSE, warning = FALSE, message = FALSE}

tenure1 <- df %>%
  mutate(dwyears = ifelse(round(dwyears) == 100, NA, dwyears)) %>% 
  ggplot() + geom_histogram(aes(x = dwyears, weight = dwsuppwt), fill = "forestgreen", alpha = 0.5) + 
  labs(x = "Years spent at lost job", title = "Histogram of Reported Tenure at Lost Job") +
  common_theme

tenure2 <- df %>%
  mutate(dwyears = ifelse(round(dwyears) == 100, NA, dwyears)) %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot(aes(x = dwyears, y = ratio_wage , weight = dwsuppwt)) + 
  geom_jitter() + 
  labs(x = "Years spent at lost job", title = "Wage Ratio versus Reported Tenure at Lost Job") +
  geom_smooth(method = "lm", color = "forestgreen", fill = "forestgreen") +
  common_theme

tenure1 + tenure2 + plot_annotation(title = "Tenure at Lost Job (years)", subtitle = "Observations weighted by Displaced Worker Supplement Weights. Annual data from 2000-2025. Exclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)

```

### Representation

Although the survey does provide sample weights which we use above, it's still likely that those who are laid off might be systematically more susceptible to layoffs (lower-wage, low-skill occupation, male, etc).
Below, some (very rough) graphs to indicate what the sample looks like.

**Headline result:** it seems the sample over-represents below-mean wage earners and women.
Age looks reasonably accurate (in relation to a simple median though....have not checked spread).
Have not yet checked match to educational attainment.
Individuals with only a HS diploma is strong majority in sample - not sure how accurate this is (likely correlated with wage however...so this might be cause for concern and confirm a skewed sample in that sense).

If we wish to pursue this data, I could improve on the below but it will have to do for now.

```{r disc_rep, echo=FALSE, warning = FALSE, message = FALSE, fig.height = 8, fig.width = 12}
# Gender
female_lfpr <- df %>% 
  filter(clipped_sample_hwage) %>% 
  group_by(female) %>% 
  summarise(tot = sum(dwsuppwt)) %>% 
  ungroup %>% 
  pivot_wider(values_from = tot, names_from = female) %>% 
  rename(male = `FALSE`, female = `TRUE`) %>% 
  summarise(female/(female + male)) %>% pull(.) %>% round(2)*100

gender <- df %>%
  filter(clipped_sample_hwage) %>%
  group_by(female) %>%
  summarise(tot = sum(dwsuppwt)) %>%
  ungroup() %>%
  mutate(
    female = ifelse(!female, "Male", "Female"),
    perc = (tot / sum(tot))*100,                        # [ADDED] Compute % share for optional labeling
    label = paste0(female, ": ", scales::comma(perc), "%")  # [ADDED] Create label with total count
  ) %>%
  ggplot(aes(x = "", y = tot, fill = female)) +
  geom_bar(width = 1, stat = "identity", color = "white") +  # [CHANGED] Added color = "white" to clean slice edges
  coord_polar("y", start = 0) +
  geom_text(                                        # [ADDED] Labels inside the pie slices
    aes(label = label),
    position = position_stack(vjust = 0.5),         # [ADDED] Vertically center labels
    size = 4,
    color = "black"
  ) +
  scale_fill_brewer(palette = "Set2", name = "Sex") +
  labs(
    title = "Gender Share of Sample",
    subtitle = paste0(
      "Female representation (ie. Female LFPR) as calculated in the sample is ", 
      female_lfpr, "%\n",
      "whereas female LFPR in the US is ~57% and their unemployment rates are roughly equal."
    )
  ) +
common_theme+                              
  theme(
    legend.position = "none")
  #   panel.grid.major = element_blank(),
  #   panel.grid.minor = element_blank(),
  #   axis.title.x = element_blank(),   
  #   axis.title.y = element_blank(),
  #   axis.text.x = element_blank(),
  #   axis.ticks = element_blank(),  
  #   axis.text.y = element_blank()
  # )

# Wage representation 
mean_wage <- df %>% 
  filter(clipped_sample_hwage) %>%  
  summarise(weighted.mean(dwwagec, dwsuppwt, na.rm = FALSE)) %>% pull(.)

wage <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot() +
  geom_histogram(aes(x = dwwagec), fill = "darkorchid", alpha = 0.7) +
  geom_vline(aes(xintercept = mean_wage), color = "darkorchid") + 
  annotate("text",
    x = mean_wage, y = 900, label = "Mean Reported Hourly Wage",
    angle = 90,
    vjust = 1.25,
    size = 4,
    color = "darkorchid"
  ) +
  geom_vline(aes(xintercept = 36), color = "orange")+
  annotate("text",
    x = 36, y = 750, label = "Mean Hourly Wage (BLS Reported - 2024)",
    angle = 90,
    vjust = -0.5,
    size = 4,
    color = "orange"
  ) +
  labs(x = "Reported Hourly Wage", y = "Count") +
  common_theme

# Education
educ <- df %>%
    filter(clipped_sample_hwage) %>% 
  group_by(educ_cat) %>%
  summarise(total = sum(dwsuppwt)) %>%
  mutate(share = total / sum(total),
         educ_cat = factor(educ_cat, levels = c("Less than HS", "HS Diploma", "Associate's", "Bachelor's", "Postgraduate Degree"))) %>%
  ggplot(aes(x = "All", y = share, fill = educ_cat)) +
  geom_col(width = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = NULL, y = "Share of Individuals", fill = "Education Level", title = "Education Attainment in Sample") + scale_fill_brewer(palette = "Set2") +
  common_theme

library(spatstat)
# age
median_age <- df %>% 
  filter(clipped_sample_hwage) %>% 
  summarise(weighted.median(age, dwsuppwt, na.rm = TRUE)) %>% pull(.)

age <- df %>% 
  filter(clipped_sample_hwage) %>% 
  ggplot() + 
  geom_histogram(aes(x = age), fill = "darkorchid4", alpha = 0.7) +
  geom_vline(aes(xintercept = median_age), color = "darkorchid4") + 
  annotate("text",
    x = median_age, y = 350, label = "Median Reported Age",
    angle = 90,
    vjust = -0.5,
    #size = 4,
    color = "darkorchid4"
  ) +
  geom_vline(aes(xintercept = 42.2), color = "darkorange") +
  annotate("text",
    x = 42.2, y = 300, label = "Median Labour Force Wage (BLS)",
    angle = 90,
    vjust = -0.5,
    #size = 4,
    color = "darkorange"
  ) +
  labs(x = "Age", y = "Count", title = "Age Distribution in Sample") +
  common_theme + 
  theme(legend.position = "none")
  

((wage + age) /  (educ + gender)) + plot_annotation(title = "Sample Composition by Age, Wage, Education, Gender, Occupation", subtitle = "Observations weighted by Displaced Worker Supplement Weights. Annual data from 2000-2025. Exclude observations reporting > 96 weeks of unemployment.", theme = plot_annotation_theme)
  

# Occupation

```
